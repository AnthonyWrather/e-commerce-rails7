#!/usr/bin/env ruby
# frozen_string_literal: true

# Track deployment to Honeybadger
# This script should be called as part of the deployment process
# (e.g., in bin/render-build.sh or CI/CD pipeline)

require_relative '../config/environment'

begin
  # Get the current git revision
  revision = `git rev-parse HEAD 2>&1`.strip
  if $?.exitstatus != 0
    warn "⚠ Warning: Failed to get git revision. Using 'unknown'."
    revision = 'unknown'
  end
  
  # Get the deployment user (fall back to 'deployment-script' if not available)
  username = ENV['USER'] || `whoami 2>&1`.strip
  local_username = username&.empty? == false ? username : 'deployment-script'
  
  # Get repository URL from git config
  repository = `git config --get remote.origin.url 2>&1`.strip
  if $?.exitstatus != 0 || repository.empty?
    # Fallback to environment variable or default
    repository = ENV.fetch('REPOSITORY_URL', 'git@github.com:AnthonyWrather/e-commerce-rails7.git')
  end
  
  # Track the deployment
  Honeybadger.track_deployment(
    environment: Rails.env,
    revision: revision,
    local_username: local_username,
    repository: repository
  )
  
  puts "✓ Deployment tracked successfully to Honeybadger"
  puts "  Environment: #{Rails.env}"
  puts "  Revision: #{revision}"
  puts "  User: #{local_username}"
  exit 0
rescue StandardError => e
  # Log error but don't fail the deployment
  warn "⚠ Warning: Failed to track deployment to Honeybadger: #{e.message}"
  exit 0
end
