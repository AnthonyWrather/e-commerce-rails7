# Exported from Render on 2025-11-23T03:17:06Z
version: "1"
projects:
- name: E-Commerce-Rails7
  environments:
  - name: Production
    databases:
    # Postgres database server for Production and Test
    - name: e_commerce_rails7_db
      databaseName: e_commerce_rails7_production
      user: e_commerce_rails7
      plan: basic-256mb
      region: frankfurt
      ipAllowList: []
      postgresMajorVersion: "17"
      diskSizeGB: 1

    services:
    # Redis for Action Cable (WebSockets) for Production and Test
    - type: redis
      name: e_commerce_rails7_redis
      plan: free
      maxmemoryPolicy: allkeys-lru
      region: frankfurt
      ipAllowList: []

    # Rails Web Application - Production
    - type: web
      name: e-commerce-rails7
      runtime: docker
      repo: https://github.com/AnthonyWrather/e-commerce-rails7
      plan: starter
      region: frankfurt
      branch: main
      dockerContext: .
      dockerfilePath: ./Dockerfile
      autoDeployTrigger: commit
      healthCheckPath: /up
      domains:
      - shop.cariana.tech
      disk:
        name: rails-disk
        mountPath: /rails/storage
        sizeGB: 1
      # Add build filters to skip rebuilds on docs changes
      buildFilter:
        paths:
          - app/**
          - config/**
          - db/**
          - lib/**
          - Gemfile
          - Gemfile.lock
        ignoredPaths:
          - '*.md'
          - documentation/**
          - .results/**
      envVars:
        # Database
        - key: DATABASE_URL
          fromDatabase:
            name: e_commerce_rails7_db
            property: connectionString
        # Redis for Action Cable
        - key: REDIS_URL
          fromService:
            type: redis
            name: e_commerce_rails7_redis
            property: connectionString
        # Rails Configuration
        - key: RAILS_MASTER_KEY
          sync: false
        - key: RAILS_ENV
          value: production
        - key: RAILS_LOG_LEVEL
          value: info
        - key: RAILS_SERVE_STATIC_FILES
          value: "true"
        # Puma Configuration
        - key: WEB_CONCURRENCY
          value: 2
        - key: RAILS_MAX_THREADS
          value: 5
        # Stripe Payment Processing
        - key: STRIPE_SECRET_KEY
          sync: false
        - key: STRIPE_WEBHOOK_KEY
          sync: false
        # MailerSend SMTP (Email)
        - key: MAILERSEND_DOMAIN
          sync: false
        - key: MAILERSEND_USERNAME
          sync: false
        - key: MAILERSEND_PASSWORD
          sync: false
        # AWS S3 for Active Storage
        # Currently stored in the secrets file.
        - key: AWS_ACCESS_KEY_ID
          sync: false
        - key: AWS_SECRET_ACCESS_KEY
          sync: false
        - key: AWS_REGION
          value: eu-central-1
        - key: AWS_BUCKET
          value: e-commerce-rails7-aws-s3-bucket

  - name: Test
    services:
    # Rails Web Application - Test
    - type: web
      name: e-commerce-rails7-test
      runtime: docker
      repo: https://github.com/AnthonyWrather/e-commerce-rails7
      plan: free
      region: frankfurt
      branch: main
      dockerContext: .
      dockerfilePath: ./Dockerfile
      autoDeployTrigger: commit
      healthCheckPath: /up
      domains:
      - test.cariana.tech  # Test subdomain
      envVars:
        # Connect to same PostgreSQL but different database
        - key: DATABASE_URL
          fromDatabase:
            name: e_commerce_rails7_db  # Same server
            property: connectionString
          # Then override database name in Rails
        - key: DATABASE_NAME
          value: e_commerce_rails7_test
        # Share same Redis
        - key: REDIS_URL
          fromService:
            type: redis
            name: e_commerce_rails7_redis  # Same server
            property: connectionString
        # Rails Configuration
        - key: RAILS_MASTER_KEY
          sync: false
        - key: RAILS_ENV
          value: test
        - key: RAILS_LOG_LEVEL
          value: debug
        - key: RAILS_SERVE_STATIC_FILES
          value: "true"
        # Puma Configuration
        - key: WEB_CONCURRENCY
          value: 1
        - key: RAILS_MAX_THREADS
          value: 5
        # Stripe Payment Processing (Test mode)
        - key: STRIPE_SECRET_KEY
          sync: false
        - key: STRIPE_WEBHOOK_KEY
          sync: false
